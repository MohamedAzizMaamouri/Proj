{% extends 'base.html.twig' %}

{% block title %}Finaliser ma commande - ENZO Collection{% endblock %}

{% block body %}
    <!-- Page Header -->
    <section class="py-4 bg-light">
        <div class="container">
            <div class="d-flex align-items-center">
                <h1 class="display-6 fw-light mb-0 me-4">Finaliser ma commande</h1>
                <!-- Progress Steps -->
                <div class="d-flex align-items-center">
                    <span class="badge bg-dark me-2">1</span>
                    <span class="small me-3">Panier</span>
                    <i class="fas fa-chevron-right text-muted me-3"></i>
                    <span class="badge bg-primary me-2">2</span>
                    <span class="small me-3 fw-600">Commande</span>
                    <i class="fas fa-chevron-right text-muted me-3"></i>
                    <span class="badge bg-light text-dark me-2">3</span>
                    <span class="small text-muted">Confirmation</span>
                </div>
            </div>
        </div>
    </section>

    <div class="container py-5">
        {{ form_start(form) }}
        <div class="row g-5">
            <!-- Order Form -->
            <div class="col-lg-8">
                <!-- Customer Information -->
                <div class="bg-white shadow-sm p-4 mb-4">
                    <h4 class="fw-light mb-4">
                        <i class="fas fa-user me-2 text-primary"></i>
                        Informations client
                    </h4>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-500">Prénom</label>
                            <input type="text" class="form-control" value="{{ app.user.firstName }}" readonly style="background-color: #f8f9fa;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-500">Nom</label>
                            <input type="text" class="form-control" value="{{ app.user.lastName }}" readonly style="background-color: #f8f9fa;">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-500">Email</label>
                            <input type="email" class="form-control" value="{{ app.user.email }}" readonly style="background-color: #f8f9fa;">
                        </div>
                    </div>
                </div>

                <!-- Shipping Information -->
                <div class="bg-white shadow-sm p-4 mb-4">
                    <h4 class="fw-light mb-4">
                        <i class="fas fa-shipping-fast me-2 text-primary"></i>
                        Adresse de livraison
                    </h4>

                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ form_row(form.shipping_firstName, {
                                'label_attr': {'class': 'form-label fw-500'}
                            }) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.shipping_lastName, {
                                'label_attr': {'class': 'form-label fw-500'}
                            }) }}
                        </div>
                        <div class="col-12">
                            {{ form_row(form.shipping_address, {
                                'label_attr': {'class': 'form-label fw-500'}
                            }) }}
                        </div>
                        <div class="col-12">
                            {{ form_row(form.shipping_addressComplement, {
                                'label_attr': {'class': 'form-label fw-500'}
                            }) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_row(form.shipping_postalCode, {
                                'label_attr': {'class': 'form-label fw-500'}
                            }) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_row(form.shipping_city, {
                                'label_attr': {'class': 'form-label fw-500'}
                            }) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_row(form.shipping_phone, {
                                'label_attr': {'class': 'form-label fw-500'}
                            }) }}
                        </div>
                    </div>
                </div>

                <!-- Billing Information -->
                <div class="bg-white shadow-sm p-4 mb-4">
                    <h4 class="fw-light mb-4">
                        <i class="fas fa-file-invoice me-2 text-primary"></i>
                        Adresse de facturation
                    </h4>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form_widget(form.sameAsBilling) }}
                            {{ form_label(form.sameAsBilling, null, {'label_attr': {'class': 'form-check-label'}}) }}
                        </div>
                    </div>

                    <div id="billingAddressFields" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form_row(form.billing_firstName, {
                                    'label_attr': {'class': 'form-label fw-500'}
                                }) }}
                            </div>
                            <div class="col-md-6">
                                {{ form_row(form.billing_lastName, {
                                    'label_attr': {'class': 'form-label fw-500'}
                                }) }}
                            </div>
                            <div class="col-12">
                                {{ form_row(form.billing_address, {
                                    'label_attr': {'class': 'form-label fw-500'}
                                }) }}
                            </div>
                            <div class="col-12">
                                {{ form_row(form.billing_addressComplement, {
                                    'label_attr': {'class': 'form-label fw-500'}
                                }) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(form.billing_postalCode, {
                                    'label_attr': {'class': 'form-label fw-500'}
                                }) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(form.billing_city, {
                                    'label_attr': {'class': 'form-label fw-500'}
                                }) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(form.billing_phone, {
                                    'label_attr': {'class': 'form-label fw-500'}
                                }) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="bg-white shadow-sm p-4">
                    <h4 class="fw-light mb-4">
                        <i class="fas fa-credit-card me-2 text-primary"></i>
                        Mode de paiement
                    </h4>

                    <div class="alert alert-info border-0" style="background-color: #e3f2fd;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-2x text-info me-3"></i>
                            <div>
                                <h6 class="fw-600 mb-1">Boutique de démonstration</h6>
                                <p class="mb-0">Aucun paiement réel ne sera effectué. Cette boutique est à des fins de démonstration uniquement.</p>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="cash" checked>
                                <label class="form-check-label w-100" for="cash">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-money-bill-wave fa-2x text-success me-3"></i>
                                        <div>
                                            <h6 class="mb-1">Paiement à la livraison</h6>
                                            <small class="text-muted">Payez en espèces lors de la réception</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card">
                                <label class="form-check-label w-100" for="card">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-credit-card fa-2x text-primary me-3"></i>
                                        <div>
                                            <h6 class="mb-1">Carte bancaire (Démo)</h6>
                                            <small class="text-muted">Simulation de paiement en ligne</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Demo Card Fields (hidden by default) -->
                    <div id="cardFields" class="mt-4" style="display: none;">
                        <div class="p-4 bg-light rounded">
                            <h6 class="fw-600 mb-3">Informations de carte (Simulation)</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-500">Numéro de carte</label>
                                    <input type="text" class="form-control" placeholder="1234 5678 9012 3456" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-500">Date d'expiration</label>
                                    <input type="text" class="form-control" placeholder="MM/AA" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-500">CVV</label>
                                    <input type="text" class="form-control" placeholder="123" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="bg-white shadow-sm p-4 sticky-top">
                    <h4 class="fw-light mb-4">Récapitulatif de commande</h4>

                    <!-- Cart Items -->
                    <div class="mb-4">
                        {% for item in cart.cartItems %}
                            <div class="d-flex align-items-center mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                <div class="me-3">
                                    {% if item.product.image %}
                                        <img src="{{ asset('uploads/images/' ~ item.product.image) }}" class="rounded" width="60" height="60" style="object-fit: cover;" alt="{{ item.product.name }}">
                                    {% else %}
                                        <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            <i class="fas fa-clock text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-600">{{ item.product.name }}</h6>
                                    <small class="text-muted d-block">{{ item.product.brand }}</small>
                                    <small class="text-muted">Qté: {{ item.quantity }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="fw-600">{{ item.subTotal|number_format(0, ',', ' ') }} DT</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Pricing Summary -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Sous-total:</span>
                            <span class="fw-600">{{ cart.total|number_format(0, ',', ' ') }} DT</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Livraison:</span>
                            <span class="text-success fw-600">Gratuite</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>TVA (19%):</span>
                            <span class="fw-600">{{ (cart.total * 0.19)|number_format(0, ',', ' ') }} DT</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <strong class="fs-5">Total:</strong>
                            <strong class="fs-5 text-primary">{{ (cart.total * 1.19)|number_format(0, ',', ' ') }} DT</strong>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-check me-2"></i>Confirmer la commande
                        </button>
                    </div>

                    <!-- Back to Cart -->
                    <div class="d-grid mb-4">
                        <a href="{{ path('app_cart_index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Retour au panier
                        </a>
                    </div>

                    <!-- Security Info -->
                    <div class="text-center p-3 bg-light rounded">
                        <div class="d-flex justify-content-center align-items-center mb-2">
                            <i class="fas fa-shield-alt text-success me-2"></i>
                            <i class="fas fa-lock text-success me-2"></i>
                            <i class="fab fa-cc-visa text-primary me-2"></i>
                            <i class="fab fa-cc-mastercard text-warning"></i>
                        </div>
                        <small class="text-muted fw-500">Paiement 100% sécurisé</small>
                    </div>

                    <!-- Delivery Info -->
                    <div class="mt-4 p-3 border rounded">
                        <h6 class="fw-600 mb-2">
                            <i class="fas fa-truck me-2 text-primary"></i>
                            Livraison
                        </h6>
                        <ul class="list-unstyled mb-0 small">
                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Livraison gratuite dans toute la Tunisie</li>
                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Délai de livraison: 2-3 jours ouvrés</li>
                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Suivi de commande par SMS</li>
                            <li><i class="fas fa-check text-success me-2"></i>Retour gratuit sous 30 jours</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {{ form_end(form) }}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle payment method fields
            const cashRadio = document.getElementById('cash');
            const cardRadio = document.getElementById('card');
            const cardFields = document.getElementById('cardFields');

            function togglePaymentFields() {
                if (cardRadio.checked) {
                    cardFields.style.display = 'block';
                } else {
                    cardFields.style.display = 'none';
                }
            }

            cashRadio.addEventListener('change', togglePaymentFields);
            cardRadio.addEventListener('change', togglePaymentFields);

            // Toggle billing address fields
            const sameAsBillingCheckbox = document.querySelector('input[name="order[sameAsBilling]"]');
            const billingAddressFields = document.getElementById('billingAddressFields');

            function toggleBillingFields() {
                if (sameAsBillingCheckbox.checked) {
                    billingAddressFields.style.display = 'none';
                    // Clear billing fields when hidden
                    billingAddressFields.querySelectorAll('input').forEach(input => {
                        input.value = '';
                    });
                } else {
                    billingAddressFields.style.display = 'block';
                }
            }

            // Initial state
            toggleBillingFields();

            sameAsBillingCheckbox.addEventListener('change', toggleBillingFields);

            // Auto-fill user data in shipping fields
            const userFirstName = "{{ app.user.firstName }}";
            const userLastName = "{{ app.user.lastName }}";

            if (userFirstName) {
                document.querySelector('input[name="order[shipping_firstName]"]').value = userFirstName;
            }
            if (userLastName) {
                document.querySelector('input[name="order[shipping_lastName]"]').value = userLastName;
            }

            // Form validation enhancement
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                const requiredFields = [
                    'order[shipping_firstName]',
                    'order[shipping_lastName]',
                    'order[shipping_address]',
                    'order[shipping_postalCode]',
                    'order[shipping_city]',
                    'order[shipping_phone]'
                ];

                let hasErrors = false;

                requiredFields.forEach(fieldName => {
                    const field = document.querySelector(`input[name="${fieldName}"]`);
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        hasErrors = true;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });

                // Validate billing fields if not same as shipping
                if (!sameAsBillingCheckbox.checked) {
                    const billingRequiredFields = [
                        'order[billing_firstName]',
                        'order[billing_lastName]',
                        'order[billing_address]',
                        'order[billing_postalCode]',
                        'order[billing_city]',
                        'order[billing_phone]'
                    ];

                    billingRequiredFields.forEach(fieldName => {
                        const field = document.querySelector(`input[name="${fieldName}"]`);
                        if (!field.value.trim()) {
                            field.classList.add('is-invalid');
                            hasErrors = true;
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });
                }

                if (hasErrors) {
                    e.preventDefault();
                    // Scroll to first error
                    const firstError = document.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }
                }
            });
        });
    </script>

    <style>
        .form-check:hover {
            background-color: #f8f9fa;
        }

        .form-check-input:checked + .form-check-label {
            color: var(--bs-primary);
        }

        .sticky-top {
            top: 20px;
        }

        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .fw-500 {
            font-weight: 500;
        }

        .fw-600 {
            font-weight: 600;
        }
    </style>
{% endblock %}
